; Code needed to run on Aduino IDE
#define __SFR_OFFSET 0x00
#include "avr/io.h"

; Add .global for any function called from Arduino
.global start
.global BEGIN


;
; Counter_Serialized_Output.asm
;
; Created: 3/5/2024 9:45:35 AM
; Author : sks260
;


; This code serialized the output of a software counter and sends the bit stream out through Bit 1 on PORT F

.MACRO	PULSE
	CBI @0, @1
	NOP
	SBI	@0, @1
	NOP
	CBI	@0, @1
.ENDMACRO
	
;--- Program Start (start called from setup() in .ino)

.ORG	$0000
start:
		SBI DDRF, 1		;SER   (A1)
		SBI DDRF, 2		;SRCLK (A2)
		SBI DDRF, 3		;RCLK  (A3)
		RET

BEGIN:	LDI R20, 0
LOOP:	
		CALL SERIAL_OUT
		INC R20
		RCALL DELAY
		CPI R20, 10		;compare R20 with 10
		BRNE LOOP		;if R20 not equal to 10, goto LOOP
		RJMP BEGIN

;--- DELAY Subroutine
DELAY: LDI R21, 64
DL1:	LDI R22, 200
DL2:	LDI R23, 250
DL3:	NOP
		NOP
		DEC R23
		BRNE DL3
		DEC R22
		BRNE DL2
		DEC R21
		BRNE DL1
		RET

;--- SERIAL_OUT subroutine
SERIAL_OUT:
	CLC
	LDI	R16,8
	CBI PORTF, 2
	SBI PORTF,1

AGAIN:	
	ROR R20
	BRCS ONE
	CBI PORTF,1
	PULSE PORTF, 2
	JMP	NEXT
ONE:	SBI PORTF,1
	PULSE PORTF, 2
NEXT:
	DEC R16
	BRNE AGAIN
	ROR R20
	SBI PORTF,1
	PULSE PORTF, 3
	RET

		